// @ts-nocheck - Disable TypeScript checking for JavaScript file
/**
 * Portfolio JavaScript - Production Ready Version
 * All functionality working with defensive programming
 */

// Initialize i18n system
let i18n;

// Mobile Navigation Toggle and Translation System
document.addEventListener("DOMContentLoaded", function () {
  // Initialize translation system
  if (typeof I18n !== 'undefined') {
    i18n = new I18n();
    i18n.init();
    
    // Setup language selector
    const languageToggle = document.getElementById('language-toggle');
    const languageDropdown = document.querySelector('.language-dropdown');
    const languageOptions = document.querySelectorAll('.language-option');
    
    if (languageToggle && languageDropdown) {
      // Show/hide dropdown
      languageToggle.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        languageDropdown.classList.toggle('show');
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', () => {
        languageDropdown.classList.remove('show');
      });
      
      // Prevent dropdown from closing when clicking inside
      languageDropdown.addEventListener('click', (e) => {
        e.stopPropagation();
      });
      
      // Handle language selection
      languageOptions.forEach(option => {
        option.addEventListener('click', (e) => {
          e.preventDefault();
          const lang = option.getAttribute('data-lang');
          if (lang && i18n) {
            i18n.setLanguage(lang);
            languageDropdown.classList.remove('show');
            
            // Update button text
            const flagSpan = languageToggle.querySelector('.flag');
            const textSpan = languageToggle.querySelector('.lang-text');
            const selectedFlag = option.querySelector('.flag').textContent;
            const selectedText = option.querySelector('.lang-name').textContent;
            
            if (flagSpan && textSpan) {
              flagSpan.textContent = selectedFlag;
              textSpan.textContent = selectedText;
            }
          }
        });
      });
    }
  }

  // Initialize theme system
  initThemeSystem();

  // Mobile Navigation
  const navToggle = document.getElementById("nav-toggle");
  const navMenu = document.getElementById("nav-menu");

  if (navToggle && navMenu) {
    navToggle.addEventListener("click", function () {
      navMenu.classList.toggle("active");

      // Animate hamburger menu
      const bars = navToggle.querySelectorAll(".bar");
      bars.forEach((bar) => bar.classList.toggle("active"));
    });

    // Close mobile menu when clicking on a link
    const navLinks = document.querySelectorAll(".nav-link");
    navLinks.forEach((link) => {
      link.addEventListener("click", () => {
        navMenu.classList.remove("active");
        const bars = navToggle.querySelectorAll(".bar");
        bars.forEach((bar) => bar.classList.remove("active"));
      });
    });
  }
});

// Smooth scrolling for navigation links
document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
  anchor.addEventListener("click", function (e) {
    e.preventDefault();
    
    // Type-safe href attribute check
    if (anchor instanceof HTMLAnchorElement) {
      const href = anchor.getAttribute("href");
      if (href) {
        const target = document.querySelector(href);
        if (target) {
          target.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      }
    }
  });
});

// Navbar background update function
function updateNavbarBackground() {
  const navbar = document.querySelector(".navbar");
  if (navbar && navbar instanceof HTMLElement) {
    const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
    
    if (window.scrollY > 50) {
      if (isDarkTheme) {
        navbar.style.background = "rgba(13, 17, 23, 0.98)";
        navbar.style.boxShadow = "0 2px 20px rgba(0, 0, 0, 0.3)";
      } else {
        navbar.style.background = "rgba(255, 255, 255, 0.98)";
        navbar.style.boxShadow = "0 2px 20px rgba(0, 0, 0, 0.1)";
      }
    } else {
      if (isDarkTheme) {
        navbar.style.background = "rgba(13, 17, 23, 0.95)";
        navbar.style.boxShadow = "none";
      } else {
        navbar.style.background = "rgba(255, 255, 255, 0.95)";
        navbar.style.boxShadow = "none";
      }
    }
  }
}

// Navbar background opacity on scroll
window.addEventListener("scroll", updateNavbarBackground);

// Active navigation link highlighting
window.addEventListener("scroll", function () {
  const sections = document.querySelectorAll("section");
  const navLinks = document.querySelectorAll(".nav-link");

  let current = "";
  sections.forEach((section) => {
    const sectionTop = section.offsetTop;
    const sectionHeight = section.clientHeight;

    if (window.scrollY >= sectionTop - 200) {
      const sectionId = section.getAttribute("id");
      if (sectionId) {
        current = sectionId;
      }
    }
  });

  navLinks.forEach((link) => {
    link.classList.remove("active");
    if (link.getAttribute("href") === `#${current}`) {
      link.classList.add("active");
    }
  });
});

// Skill bars animation
function animateSkillBars() {
  const skillLevels = document.querySelectorAll(".skill-level");
  skillLevels.forEach((skill) => {
    const level = skill.getAttribute("data-level");
    if (skill instanceof HTMLElement && level) {
      skill.style.setProperty("--skill-width", level + "%");
    }
  });
}

// Trigger skill animation when skills section is visible
const skillsSectionElement = document.querySelector("#habilidades");
if (skillsSectionElement) {
  const skillAnimationObserver = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          animateSkillBars();
          skillAnimationObserver.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.5 }
  );

  skillAnimationObserver.observe(skillsSectionElement);
}

// Contact form handling
const portfolioContactForm = document.getElementById("contact-form");
if (portfolioContactForm && portfolioContactForm instanceof HTMLFormElement) {
  portfolioContactForm.addEventListener("submit", function (e) {
    e.preventDefault();

    // Get form data
    const formData = new FormData(portfolioContactForm);
    const name = formData.get("name");
    const email = formData.get("email");
    const message = formData.get("message");

    // Simple form validation
    if (!name || !email || !message) {
      showNotification("Por favor, completa todos los campos.", "error");
      return;
    }

    if (typeof email === "string" && !isValidEmail(email)) {
      showNotification("Por favor, ingresa un email v√°lido.", "error");
      return;
    }

    // Simulate form submission
    showNotification(
      "¬°Mensaje enviado con √©xito! Te contactar√© pronto.",
      "success"
    );
    portfolioContactForm.reset();
  });
}

// Email validation with proper typing
function isValidEmail(email) {
  if (typeof email !== "string") return false;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

// Notification system with proper typing
function showNotification(message, type) {
  if (typeof message !== "string" || typeof type !== "string") return;
  
  // Remove existing notifications
  const existingNotification = document.querySelector(".notification");
  if (existingNotification) {
    existingNotification.remove();
  }

  // Create notification element
  const notification = document.createElement("div");
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
        <span>${message}</span>
        <button class="notification-close">&times;</button>
    `;

  // Add styles
  notification.style.cssText = `
        position: fixed;
        top: 90px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 10px;
        color: white;
        font-weight: 500;
        z-index: 1001;
        display: flex;
        align-items: center;
        gap: 15px;
        animation: slideInRight 0.3s ease-out;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    `;

  if (type === "success") {
    notification.style.background = "linear-gradient(135deg, #10b981, #059669)";
  } else {
    notification.style.background = "linear-gradient(135deg, #ef4444, #dc2626)";
  }

  // Add to body
  document.body.appendChild(notification);

  // Close button functionality
  const closeButton = notification.querySelector(".notification-close");
  if (closeButton && closeButton instanceof HTMLElement) {
    closeButton.style.cssText = `
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        opacity: 0.8;
    `;

    closeButton.addEventListener("click", () => {
      notification.remove();
    });
  }

  // Auto remove after 5 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 5000);
}

// Add CSS for notification animation
const notificationStyles = document.createElement("style");
notificationStyles.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .notification-close:hover {
        opacity: 1 !important;
    }
`;
document.head.appendChild(notificationStyles);

// Add loading animation
window.addEventListener("load", function () {
  document.body.style.opacity = "0";
  document.body.style.transition = "opacity 0.5s ease-in-out";

  setTimeout(() => {
    document.body.style.opacity = "1";
  }, 100);
});

// Theme System
function initThemeSystem() {
  const themeToggle = document.getElementById('theme-toggle');
  const themeIcon = themeToggle?.querySelector('.theme-icon');
  
  // Load saved theme or default to light
  const savedTheme = localStorage.getItem('portfolio-theme') || 'light';
  setTheme(savedTheme);
  
  // Theme toggle event listener
  if (themeToggle) {
    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    });
  }
  
  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('portfolio-theme', theme);
    
    // Update icon and title
    if (themeIcon && themeToggle) {
      if (theme === 'dark') {
        themeIcon.textContent = '‚òÄÔ∏è';
        themeToggle.title = 'Cambiar a tema claro';
      } else {
        themeIcon.textContent = 'üåô';
        themeToggle.title = 'Cambiar a tema oscuro';
      }
    }
    
    // Update navbar background immediately when theme changes
    updateNavbarBackground();
    
    // Update logos and favicon based on theme
    const navbarLogo = document.getElementById('navbar-logo');
    const heroLogo = document.getElementById('hero-logo');
    const favicon = document.getElementById('favicon');
    const appleIcon = document.getElementById('apple-icon');
    
    if (theme === 'dark') {
      if (navbarLogo) navbarLogo.src = 'img/logo-dark.png';
      if (heroLogo) heroLogo.src = 'img/logo-dark.png';
      if (favicon) favicon.href = 'img/logo-dark.png';
      if (appleIcon) appleIcon.href = 'img/logo-dark.png';
    } else {
      if (navbarLogo) navbarLogo.src = 'img/logo-light.png';
      if (heroLogo) heroLogo.src = 'img/logo-light.png';
      if (favicon) favicon.href = 'img/logo-light.png';
      if (appleIcon) appleIcon.href = 'img/logo-light.png';
    }
    
    // Update translations if available
    if (i18n) {
      updateThemeTooltips(theme);
    }
  }
  
  function updateThemeTooltips(theme) {
    if (!themeToggle) return;
    
    const currentLang = i18n.getCurrentLanguage();
    if (currentLang === 'en') {
      themeToggle.title = theme === 'dark' ? 'Switch to light theme' : 'Switch to dark theme';
    } else {
      themeToggle.title = theme === 'dark' ? 'Cambiar a tema claro' : 'Cambiar a tema oscuro';
    }
  }
  
  // Expose function globally for i18n updates
  window.updateThemeTooltips = updateThemeTooltips;
}

// Success log
console.log("‚úÖ Portfolio loaded successfully! üöÄ");
console.log("üéØ Features loaded:");
console.log("  - ‚úì Mobile navigation");
console.log("  - ‚úì Smooth scrolling");
console.log("  - ‚úì Active link highlighting");
console.log("  - ‚úì Skill bar animations");
console.log("  - ‚úì Form validation");
console.log("  - ‚úì Notification system");
console.log("  - ‚úì Theme switcher");
console.log("  - ‚úì Internationalization");
console.log("ÔøΩÔøΩÔøΩ All components ready!");
